# Scheduled workflow to run the email_system script at China time:
#  - 09:00 Asia/Shanghai -> morning_brief
#  - 12:00 Asia/Shanghai -> midday_review
#  - 16:30 Asia/Shanghai -> eod_summary
#
# Notes:
#  - GitHub Actions cron expressions use UTC. This workflow sets three UTC cron entries
#    that correspond to the above Asia/Shanghai times: 09:00 (UTC+8) -> 01:00 UTC, etc.
#  - The job determines the local Asia/Shanghai time at runtime and picks the report type.
#  - Configure STOCK_SCANNER_URL (e.g. https://your-host:8000) as a repository secret for safety.
#  - If your script filename differs, update the path in the final run step.
on:
  schedule:
    - cron: '0 1 * * *'    # 09:00 Asia/Shanghai
    - cron: '0 4 * * *'    # 12:00 Asia/Shanghai
    - cron: '30 8 * * *'   # 16:30 Asia/Shanghai
  workflow_dispatch: {}

name: Send Stock Reports

permissions:
  contents: read

jobs:
  send_reports:
    runs-on: ubuntu-latest
    # Provide the stock-scanner-mcp base URL via repository secret STOCK_SCANNER_URL
    # (e.g. http://localhost:8000 or https://your-host:8000)
    env:
      STOCK_SCANNER_URL: ${{ secrets.STOCK_SCANNER_URL }}
      # Optionally add other secrets here if you modify the script to read them:
      # SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      # SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      # SMTP_HOST: ${{ secrets.SMTP_HOST }}
      # SMTP_PORT: ${{ secrets.SMTP_PORT }}
      # SMTP_USER: ${{ secrets.SMTP_USER }}
      # RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      # ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # install minimal dependency used by script; add more if needed
          pip install requests

      - name: Determine report type (Asia/Shanghai) and run email script
        # The script filename here is "email_system (1).py" as you provided earlier.
        # If your file name/path differs, update the command below.
        run: |
          echo "STOCK_SCANNER_URL=${STOCK_SCANNER_URL}"
          echo "Current UTC time: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          # compute Asia/Shanghai local time
          now=$(TZ=Asia/Shanghai date +'%H:%M')
          echo "Asia/Shanghai local time: $now"
          if [ "$now" = "09:00" ]; then
            REPORT_TYPE="morning_brief"
          elif [ "$now" = "12:00" ]; then
            REPORT_TYPE="midday_review"
          elif [ "$now" = "16:30" ]; then
            REPORT_TYPE="eod_summary"
          else
            echo "Schedule triggered at unexpected local time ($now). Exiting without sending."
            # Exit with success so this scheduled run does not mark as failed
            exit 0
          fi
          echo "Selected report type: $REPORT_TYPE"
          # show python version
          python --version
          # Run the script (adjust path if necessary)
          python "email_system.py" "$REPORT_TYPE"
        working-directory: ${{ github.workspace }}
