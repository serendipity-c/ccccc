# Scheduled workflow to run the email_system script at China time:
#  - 09:00 Asia/Shanghai -> morning_brief
#  - 12:00 Asia/Shanghai -> midday_review
#  - 16:30 Asia/Shanghai -> eod_summary
#
# Includes manual dispatch (workflow_dispatch) to test:
#  - You can optionally pass `report_type` (morning_brief | midday_review | eod_summary)
#    and `stock_scanner_url` to override the configured URL for a single test run.
#
# Notes:
#  - Configure STOCK_SCANNER_URL as a repository secret for normal runs.
#  - If you trigger manually, you may supply a `stock_scanner_url` input to override the secret.
on:
  schedule:
    - cron: '0 1 * * *'    # 09:00 Asia/Shanghai
    - cron: '0 4 * * *'    # 12:00 Asia/Shanghai
    - cron: '30 8 * * *'   # 16:30 Asia/Shanghai
  workflow_dispatch:
    inputs:
      report_type:
        description: 'Optional. One of: morning_brief, midday_review, eod_summary. If empty, schedule time decides.'
        required: false
        default: ''
        type: choice
        options:
          - morning_brief
          - midday_review
          - eod_summary
      stock_scanner_url:
        description: 'Optional. Override STOCK_SCANNER_URL for this run (e.g. http://localhost:8000).'
        required: false
        default: ''

name: Send Stock Reports

permissions:
  contents: read

jobs:
  send_reports:
    runs-on: ubuntu-latest
    env:
      # Expose the repository secret here; may be empty if you haven't set it.
      SECRET_STOCK_SCANNER_URL: ${{ secrets.STOCK_SCANNER_URL }}
      # Other sensitive values should be provided as secrets and optionally passed into the job if you change the script to read them from env.
      # Example (recommended): add SUPABASE_SERVICE_KEY, RESEND_API_KEY, SMTP credentials as secrets and map them here.
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Determine report type (Asia/Shanghai) and run email script
        env:
          # Inputs provided via workflow_dispatch (may be empty)
          INPUT_REPORT: ${{ github.event.inputs.report_type }}
          INPUT_SCANNER_URL: ${{ github.event.inputs.stock_scanner_url }}
          SECRET_SCANNER_URL: ${{ env.SECRET_STOCK_SCANNER_URL }}
        run: |
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Manual input report_type: '$INPUT_REPORT'"
          echo "Manual input stock_scanner_url: '$INPUT_SCANNER_URL'"
          # Decide STOCK_SCANNER_URL: prefer manual input, otherwise repo secret
          if [ -n "$INPUT_SCANNER_URL" ]; then
            export STOCK_SCANNER_URL="$INPUT_SCANNER_URL"
          else
            export STOCK_SCANNER_URL="$SECRET_SCANNER_URL"
          fi
          echo "Using STOCK_SCANNER_URL=$STOCK_SCANNER_URL"

          # If manual report_type supplied, use it; otherwise infer by Asia/Shanghai time
          if [ -n "$INPUT_REPORT" ]; then
            REPORT_TYPE="$INPUT_REPORT"
            echo "Using manual REPORT_TYPE=$REPORT_TYPE"
          else
            now=$(TZ=Asia/Shanghai date +'%H:%M')
            echo "Asia/Shanghai local time: $now"
            if [ "$now" = "09:00" ]; then
              REPORT_TYPE="morning_brief"
            elif [ "$now" = "12:00" ]; then
              REPORT_TYPE="midday_review"
            elif [ "$now" = "16:30" ]; then
              REPORT_TYPE="eod_summary"
            else
              echo "Schedule triggered at unexpected local time ($now) and no manual report_type provided. Exiting."
              exit 0
            fi
            echo "Selected REPORT_TYPE based on schedule: $REPORT_TYPE"
          fi

          # show python version
          python --version

          # Run the script (update filename/path if necessary)
          # If your script file name contains spaces (like "email_system (1).py") keep the quotes,
          # but it's recommended to rename it to something without spaces.
          python "email_system (1).py" "$REPORT_TYPE"
        working-directory: ${{ github.workspace }}
