name: Scheduled Stock Email Reports

on:
  schedule:
    - cron: '30 0 * * *'
    - cron: '0 4 * * *'
    - cron: '30 8 * * *'
  workflow_dispatch:
    inputs:
      report_type:
        description: '手动运行的报告类型：morning_brief | midday_review | eod_summary | all | by_time（按当前上海时间判断），默认 by_time'
        required: false
        default: 'by_time'

jobs:
  run_report:
    name: Run scheduled or manual report (Shanghai time aware)
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
      # 将 GitHub Secrets 注入到 runner 环境中（你已经在仓库设置里添加好）
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}        # 可选（若你设置了）
      SMTP_USER: ${{ secrets.SMTP_USER }}        # 可选
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}      # 可选
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies (with mirror, show install logs)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
          else
            pip install requests pandas numpy lxml beautifulsoup4 openpyxl -i https://pypi.tuna.tsinghua.edu.cn/simple
            pip install akshare zhipuai -i https://pypi.tuna.tsinghua.edu.cn/simple || true
          fi
          echo "=== pip list (first 40) ==="
          pip list | sed -n '1,40p'
          echo "=== pip show akshare ==="
          pip show akshare || echo "akshare not installed"
          echo "=== pip show zhipuai ==="
          pip show zhipuai || echo "zhipuai not installed"

      - name: Run report (manual or scheduled)
        env:
          EVENT_NAME: ${{ github.event_name }}
          INPUT_REPORT: ${{ github.event.inputs.report_type }}
        run: |
          set -euo pipefail || true

          CURRENT_TIME=$(TZ=Asia/Shanghai date +'%H:%M')
          echo "Event: $EVENT_NAME"
          echo "Input report_type: '${INPUT_REPORT}'"
          echo "Current Shanghai time: $CURRENT_TIME"

          run_by_time() {
            if [ "$CURRENT_TIME" = "08:30" ]; then
              echo "Detected 08:30 Shanghai time -> running morning_brief"
              python email_system.py morning_brief
            elif [ "$CURRENT_TIME" = "12:00" ]; then
              echo "Detected 12:00 Shanghai time -> running midday_review"
              python email_system.py midday_review
            elif [ "$CURRENT_TIME" = "16:30" ]; then
              echo "Detected 16:30 Shanghai time -> running eod_summary"
              python email_system.py eod_summary
            else
              echo "Not a scheduled time (08:30/12:00/16:30). Exiting without running reports."
            fi
          }

          if [ "${EVENT_NAME}" = "workflow_dispatch" ]; then
            if [ -n "${INPUT_REPORT}" ] && [ "${INPUT_REPORT}" != "by_time" ]; then
              if [ "${INPUT_REPORT}" = "all" ]; then
                python email_system.py morning_brief || echo "morning_brief failed"
                python email_system.py midday_review || echo "midday_review failed"
                python email_system.py eod_summary || echo "eod_summary failed"
              else
                python email_system.py "${INPUT_REPORT}"
              fi
            else
              run_by_time
            fi
          else
            run_by_time
          fi
