# 每日定时在 Asia/Shanghai (UTC+8) 的 08:00, 12:00, 16:30 运行 email_system.py
# 说明：
# - 该 workflow 设计为在你的 self-hosted runner（在本地注册的 runner）上运行，
#   以便能访问本地运行的 DR-lin-eng/stock-scanner 服务与本地资源。
# - 请在你的 self-hosted runner 注册时使用 label（例如 "local-runner"），
#   然后把 runs-on 设置为 [self-hosted, linux, local-runner]。
# - 在仓库 Secrets 配置下列敏感项并映射到 runner 的环境（推荐）：
#     SUPABASE_SERVICE_KEY, RESEND_API_KEY, SMTP_HOST, SMTP_PORT, SMTP_USER, FROM_EMAIL, FROM_NAME
# - workflow_dispatch 提供手动触发与 report_type 覆盖，用于测试。
on:
  schedule:
    - cron: '0 0 * * *'    # 08:00 Asia/Shanghai -> 00:00 UTC
    - cron: '0 4 * * *'    # 12:00 Asia/Shanghai -> 04:00 UTC
    - cron: '30 8 * * *'   # 16:30 Asia/Shanghai -> 08:30 UTC
  workflow_dispatch:
    inputs:
      report_type:
        description: '可选：覆盖报告类型 (morning_brief | midday_review | eod_summary)'
        required: false
        default: ''
        type: choice
        options:
          - morning_brief
          - midday_review
          - eod_summary

name: Send Stock Reports (self-hosted)

permissions:
  contents: read

jobs:
  send_reports:
    # 请确保你的 self-hosted runner 已注册并带有 local-runner 标签
    runs-on: [self-hosted, linux, local-runner]

    # 将敏感配置通过 secrets 注入到 job 环境中（建议在仓库 Secrets 中配置）
    env:
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}
      FROM_NAME: ${{ secrets.FROM_NAME }}
      # 如果你希望脚本在 runner 上启动 Flask 并监听 localhost:5000，默认无需额外 URL
      DR_FLASK_HOST: "0.0.0.0"
      DR_FLASK_PORT: "5000"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install requests python-dotenv
          fi

      - name: Run email_system.py (decide report type by Asia/Shanghai local time)
        env:
          INPUT_REPORT: ${{ github.event.inputs.report_type }}
        run: |
          set -e
          echo "Manual input report_type: '$INPUT_REPORT'"

          # Prefer manual override when provided
          if [ -n "$INPUT_REPORT" ]; then
            REPORT_TYPE="$INPUT_REPORT"
            echo "Using manual REPORT_TYPE=$REPORT_TYPE"
          else
            # Compute Asia/Shanghai local time and derive report type
            now=$(TZ=Asia/Shanghai date +'%H:%M')
            echo "Asia/Shanghai local time: $now"
            if [ "$now" = "08:00" ]; then
              REPORT_TYPE="morning_brief"
            elif [ "$now" = "12:00" ]; then
              REPORT_TYPE="midday_review"
            elif [ "$now" = "16:30" ]; then
              REPORT_TYPE="eod_summary"
            else
              echo "Triggered at unexpected local time ($now) and no manual report_type provided — exiting without sending."
              exit 0
            fi
            echo "Selected REPORT_TYPE based on schedule: $REPORT_TYPE"
          fi

          # Show Python version and basic env
          python --version
          echo "Using SUPABASE_SERVICE_KEY: ${SUPABASE_SERVICE_KEY:+(set)}"
          echo "Using DR_FLASK_HOST=$DR_FLASK_HOST DR_FLASK_PORT=$DR_FLASK_PORT"

          # Run the email_system script (ensure filename/path is correct)
          if [ ! -f "./email_system.py" ]; then
            echo "错误：找不到 email_system.py，请确保文件在仓库根目录或调整路径"
            exit 1
          fi

          # Run the program with the selected report type
          # The script will instantiate WebStockAnalyzer and (optionally) start Flask in background,
          # then analyze users' watchlists and send emails.
          python email_system.py "$REPORT_TYPE"
        working-directory: ${{ github.workspace }}
