name: Scheduled Stock Email Reports

on:
  # ���个 cron 条目（按 UTC 时间设置以匹配北京时间 Asia/Shanghai）
  # - 08:30 Asia/Shanghai => 00:30 UTC
  # - 12:00 Asia/Shanghai => 04:00 UTC
  # - 16:30 Asia/Shanghai => 08:30 UTC
  schedule:
    - cron: '30 0 * * *'
    - cron: '0 4 * * *'
    - cron: '30 8 * * *'
  workflow_dispatch: {}

jobs:
  run_report:
    name: Run scheduled report (detect by Shanghai time)
    runs-on: ubuntu-latest
    env:
      # 明确时区为上海，脚本中使用 `date` 时将以此为准
      TZ: Asia/Shanghai
      # 可选：如果你修改了 email_system.py 以从环境变量读取密钥，
      # 你可以在此处将 GitHub Secrets 注入为环境变量，例如：
      # RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      # SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      # ZHIPUAI_API_KEY: ${{ secrets.ZHIPUAI_API_KEY }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            # 根据 email_system.py 中的引用，安装常用依赖（如需其它包可添加）
            pip install requests zhipuai akshare
          fi

      - name: Run scheduled report (choose by Shanghai time)
        run: |
          # 获取北京时间（Asia/Shanghai）
          CURRENT_TIME=$(TZ=Asia/Shanghai date +'%H:%M')
          echo "Current Shanghai time: $CURRENT_TIME"
          if [ "$CURRENT_TIME" = "08:30" ]; then
            echo "Running morning_brief"
            python email_system.py morning_brief
          elif [ "$CURRENT_TIME" = "12:00" ]; then
            echo "Running midday_review"
            python email_system.py midday_review
          elif [ "$CURRENT_TIME" = "16:30" ]; then
            echo "Running eod_summary"
            python email_system.py eod_summary
          else
            echo "Not a scheduled time. Exiting."
          fi
