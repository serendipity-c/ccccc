# 调度与手动触发的工作流：在 Asia/Shanghai 时间点发送报告（09:00、12:00、16:30）
# 使用 DR-lin-eng/stock-scanner 服务（通过 DR_STOCK_SCANNER_URL 环境变量 / Secret）
#
# 支持：
#  - 定时触发（三个 cron）
#  - 手动触发（workflow_dispatch），可通过 inputs 指定 report_type 和 dr_stock_scanner_url 覆盖 secret（仅本次运行）
#
# 使用说明：
#  - 请在仓库 Secrets 中添加 DR_STOCK_SCANNER_URL（值示例：http://your-host:8443）
#  - 推荐把 SUPABASE_SERVICE_KEY、RESEND_API_KEY、SMTP 凭据等也设为 Secrets 并在脚本中从 env 读取。
on:
  schedule:
    - cron: '0 1 * * *'    # 09:00 Asia/Shanghai
    - cron: '0 4 * * *'    # 12:00 Asia/Shanghai
    - cron: '30 8 * * *'   # 16:30 Asia/Shanghai
  workflow_dispatch:
    inputs:
      report_type:
        description: '（可选）指定报告类型：morning_brief | midday_review | eod_summary。若不填写则依调度时间决定。'
        required: false
        default: ''
        type: choice
        options:
          - morning_brief
          - midday_review
          - eod_summary
      dr_stock_scanner_url:
        description: '（可选）本次运行覆盖 DR_STOCK_SCANNER_URL（例如 http://localhost:8443）'
        required: false
        default: ''

name: Send Stock Reports (DR stock-scanner)

permissions:
  contents: read

jobs:
  send_reports:
    runs-on: ubuntu-latest
    env:
      # 从 Secrets 读取默认 DR scanner 地址（推荐配置）
      SECRET_DR_STOCK_SCANNER_URL: ${{ secrets.DR_STOCK_SCANNER_URL }}
      # 你也可以在 Secrets 中添加并映射更多敏感配置，例如：
      # SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
      # RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
      # SMTP_HOST: ${{ secrets.SMTP_HOST }}
      # SMTP_PORT: ${{ secrets.SMTP_PORT }}
      # SMTP_USER: ${{ secrets.SMTP_USER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests python-dotenv

      - name: Determine report type (Asia/Shanghai) and run email_system.py
        env:
          INPUT_REPORT: ${{ github.event.inputs.report_type }}
          INPUT_DR_SCANNER_URL: ${{ github.event.inputs.dr_stock_scanner_url }}
          SECRET_DR_SCANNER_URL: ${{ env.SECRET_DR_STOCK_SCANNER_URL }}
          # If you stored other secrets above, expose them here for the script to read:
          # SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          # RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          # SMTP_HOST: ${{ secrets.SMTP_HOST }}
          # SMTP_PORT: ${{ secrets.SMTP_PORT }}
          # SMTP_USER: ${{ secrets.SMTP_USER }}
        run: |
          set -e
          echo "Event: $GITHUB_EVENT_NAME"
          echo "Manual input report_type: '$INPUT_REPORT'"
          echo "Manual input dr_stock_scanner_url: '$INPUT_DR_SCANNER_URL'"

          # Decide DR_STOCK_SCANNER_URL: prefer manual input, otherwise repo secret
          if [ -n "$INPUT_DR_SCANNER_URL" ]; then
            export DR_STOCK_SCANNER_URL="$INPUT_DR_SCANNER_URL"
          else
            export DR_STOCK_SCANNER_URL="$SECRET_DR_SCANNER_URL"
          fi
          echo "Using DR_STOCK_SCANNER_URL=$DR_STOCK_SCANNER_URL"

          # Determine report type: manual override wins; otherwise infer from Asia/Shanghai local time
          if [ -n "$INPUT_REPORT" ]; then
            REPORT_TYPE="$INPUT_REPORT"
            echo "Using manual REPORT_TYPE=$REPORT_TYPE"
          else
            now=$(TZ=Asia/Shanghai date +'%H:%M')
            echo "Asia/Shanghai local time: $now"
            if [ "$now" = "09:00" ]; then
              REPORT_TYPE="morning_brief"
            elif [ "$now" = "12:00" ]; then
              REPORT_TYPE="midday_review"
            elif [ "$now" = "16:30" ]; then
              REPORT_TYPE="eod_summary"
            else
              echo "Schedule triggered at unexpected local time ($now) and no manual report_type provided. Exiting successfully."
              exit 0
            fi
            echo "Selected REPORT_TYPE based on schedule: $REPORT_TYPE"
          fi

          python --version
          # Run the script; ensure your script reads DR_STOCK_SCANNER_URL from env
          # The script filename is assumed to be 'email_system.py'
          if [ ! -f "./email_system.py" ]; then
            echo "错误：找不到 email_system.py，请确认文件名与路径正确"
            exit 1
          fi
          # Pass the report type to the script
          DR_STOCK_SCANNER_URL="$DR_STOCK_SCANNER_URL" python email_system.py "$REPORT_TYPE"
        working-directory: ${{ github.workspace }}
