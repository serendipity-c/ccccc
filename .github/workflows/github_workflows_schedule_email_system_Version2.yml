name: Scheduled Email System

# 使用多个 cron 条目（注意：GitHub Actions 的 cron 使用 UTC）
on:
  schedule:
    - cron: '0 1 * * *'   # 对应 北京时间 09:00
    - cron: '0 4 * * *'   # 对应 北京时间 12:00
    - cron: '30 8 * * *'  # 对应 北京时间 16:30
  workflow_dispatch:
    inputs:
      task:
        description: '手动触发要执行的任务 (morning_brief | midday_review | eod_summary)'
        required: false
        default: ''

jobs:
  run_email_task:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install jq (用于解析事件 payload)
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Install dependencies (if requirements.txt exists)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run task according to trigger
        env:
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: |
          set -e
          EVENT_FILE="$GITHUB_EVENT_PATH"
          # 读取 schedule.cron（定时触发）和 inputs.task（手动触发）
          CRON=$(jq -r '.schedule.cron // empty' "$EVENT_FILE")
          INPUT_TASK=$(jq -r '.inputs.task // empty' "$EVENT_FILE")
          echo "Event name: ${{ github.event_name }}"
          echo "Detected cron: $CRON"
          echo "Detected input task: $INPUT_TASK"

          if [ -n "$INPUT_TASK" ]; then
            echo "Manual run: executing task '$INPUT_TASK'"
            python email_system.py "$INPUT_TASK"
            exit 0
          fi

          case "$CRON" in
            "0 1 * * *")
              echo "Scheduled run for Beijing 09:00 -> launching morning_brief"
              python email_system.py morning_brief
              ;;
            "0 4 * * *")
              echo "Scheduled run for Beijing 12:00 -> launching midday_review"
              python email_system.py midday_review
              ;;
            "30 8 * * *")
              echo "Scheduled run for Beijing 16:30 -> launching eod_summary"
              python email_system.py eod_summary
              ;;
            *)
              echo "No matching cron. Exiting."
              ;;
          esac